
<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BOL Timer ‚Äì Admin</title>
  <meta name="theme-color" content="#00539f">
  <style>
:root{--tesco-blue:#00539f;--tesco-red:#e41e26;--bg:#f8fafc;--card:#ffffff;--muted:#6b7280;--radius:16px}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#0f172a}
.wrap{max-width:1000px;margin:0 auto;padding:18px}
h1{margin:0 0 6px;color:var(--tesco-blue);font-weight:900;letter-spacing:.2px}
h2{margin:0 0 10px;color:#111827}
.muted{color:var(--muted)}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:var(--radius);box-shadow:0 8px 22px rgba(0,0,0,.04);padding:16px;margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
label{font-weight:800;display:block;margin-bottom:6px}
input,select{padding:12px;border:2px solid var(--tesco-blue);border-radius:12px;width:100%;font-size:16px}
.btn{padding:12px 16px;border-radius:12px;border:2px solid var(--tesco-blue);background:var(--tesco-blue);color:#fff;font-weight:800;cursor:pointer}
.btn.ghost{background:#fff;color:var(--tesco-blue)}
.btn.danger{background:var(--tesco-red);border-color:var(--tesco-red)}
.btn.gray{background:#fff;color:#111;border-color:#e5e7eb}
.timer{font-size:40px;font-weight:900;color:var(--tesco-red)}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:9px;border-bottom:1px solid #e5e7eb}
th{border-bottom:2px solid var(--tesco-blue);text-align:left;background:#f1f5f9}
/* camera modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal.show{display:flex}
.modal .box{background:#fff;border-radius:16px;max-width:420px;width:100%;padding:14px;border:1px solid #e5e7eb}
.video-wrap{position:relative}
video{width:100%;background:#000;border-radius:12px;max-height:260px}
canvas{display:none}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#dbeafe;color:#1e3a8a;font-weight:800}
.note{background:#fff3cd;border:1px solid #ffe08a;color:#7a5d00;border-radius:8px;padding:8px 10px}
footer{margin-top:24px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Admin ‚Äì BOL Timer</h1>
    <div id="loginCard" class="card" style="display:none">
      <h2>Prihl√°senie</h2>
      <div class="row">
        <div style="flex:1 1 220px">
          <label>Meno</label>
          <input id="u" placeholder="admin" autocomplete="username" />
        </div>
        <div style="flex:1 1 220px">
          <label>Heslo</label>
          <input id="p" type="password" placeholder="admin" autocomplete="current-password" />
        </div>
        <div style="flex:0 0 160px;align-self:flex-end">
          <button id="loginBtn" class="btn">Prihl√°si≈•</button>
        </div>
      </div>
      <p class="note">Demo pr√≠stup: <b>admin / admin</b></p>
    </div>

    <div id="adminUI" style="display:none">
      <div class="card">
        <h2>Z√°znamy <span class="muted">(server CSV)</span></h2>
<div class="row" style="margin-bottom:8px">
  <button id="reload" class="btn ghost">üîÑ Znova naƒç√≠ta≈•</button>
  <button id="export" class="btn ghost">‚¨áÔ∏é Export CSV</button>
  <div class="muted" style="margin-left:auto">Poƒçet: <b id="count">0</b></div>
</div>
        <div class="row">
          <div><label>D√°tum od</label><input id="from" type="date"></div>
          <div><label>D√°tum do</label><input id="to" type="date"></div>
          <div style="align-self:flex-end"><button id="filter" class="btn ghost">Filtrova≈•</button></div>
          <div style="margin-left:auto;align-self:flex-end;display:flex;gap:8px">
            <button id="export" class="btn ghost">Export CSV</button>
            <button id="clear" class="btn danger">Vymaza≈• v≈°etko</button>
          </div>
        </div>
        <table>
          <thead><tr><th></th><th>K√≥d</th><th>Meno</th><th>≈†tart</th><th>Koniec</th><th>ƒåist√Ω ƒças</th><th>Pauzy</th><th>Zostalo</th></tr></thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>

    <footer>¬© Tesco ‚Äì admin rozhranie</footer>
  </div>

  <script>
    // Admin ‚Äì naƒç√≠tanie d√°t priamo zo serverov√©ho CSV
    const CSV_URL = './server/bol_timer_log.csv'; // relat√≠vne k admin.html
    const $ = s => document.querySelector(s);

    // jednoduch√Ω CSV parser (podpora √∫vodzoviek a ƒçiarky v poli)
    function parseCSV(text) {
      const rows = [];
      let i=0, field='', row=[], inQuotes=false;
      while (i < text.length) {
        const ch = text[i];
        if (inQuotes) {
          if (ch === '"') {
            if (text[i+1] === '"') { field += '"'; i+=2; continue; }
            inQuotes = false; i++; continue;
          } else { field += ch; i++; continue; }
        } else {
          if (ch === '"') { inQuotes = true; i++; continue; }
          if (ch === ',') { row.push(field); field=''; i++; continue; }
          if (ch === '\n' || ch === '\r') {
            // finish row
            if (field.length || row.length) { row.push(field); rows.push(row); }
            field=''; row=[];
            // skip \r\n
            if (ch === '\r' && text[i+1] === '\n') i+=2; else i++;
            continue;
          }
          field += ch; i++;
        }
      }
      if (field.length || row.length) { row.push(field); rows.push(row); }
      // remove BOM from first cell if present
      if (rows.length && rows[0].length) {
        rows[0][0] = rows[0][0].replace(/^\ufeff/, '');
      }
      return rows;
    }

    function fmt(n){return String(n).padStart(2,'0');}

    async function loadServerCSV() {
      try {
        const res = await fetch(CSV_URL, { cache: 'no-cache' });
        if (!res.ok) throw new Error('CSV not found');
        const text = await res.text();
        const rows = parseCSV(text);
        // first row header: BOL,Meno,≈†tart,Koniec,ƒåist√Ω ƒças,Pauzy,Zostalo (kart√≥ny)
        const data = [];
        for (let r=1; r<rows.length; r++) {
          const cols = rows[r];
          if (cols.length < 7) continue;
          data.push({
            code: cols[0],
            name: cols[1],
            start: cols[2],
            end: cols[3],
            clean: cols[4],
            pauses: cols[5],
            left: cols[6]
          });
        }
        return data;
      } catch (e) {
        console.warn('CSV fetch failed, falling back to localStorage', e);
        // fallback: read localStorage DB
        try {
          const db = JSON.parse(localStorage.getItem('bol_timer_pro_v1') || '{"tasks":[]}');
          return db.tasks.map(t => ({
            code: t.code,
            name: t.name,
            start: new Date(t.startISO).toLocaleString('sk-SK'),
            end: new Date(t.endISO).toLocaleString('sk-SK'),
            clean: (function(ms){ const s=Math.floor(ms/1000); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; return fmt(h)+':'+fmt(m)+':'+fmt(sec); })(t.cleanMs),
            pauses: String(t.pauses),
            left: String(t.leftoverCartons||0)
          }));
        } catch {
          return [];
        }
      }
    }

    async function renderAdmin() {
      const rows = await loadServerCSV();
      const tbody = document.getElementById('tbl');
      tbody.innerHTML = '';
      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td></td>' +
          '<td>'+r.code+'</td>' +
          '<td>'+r.name+'</td>' +
          '<td>'+r.start+'</td>' +
          '<td>'+r.end+'</td>' +
          '<td style="color:var(--tesco-red);font-weight:800">'+r.clean+'</td>' +
          '<td>'+r.pauses+'</td>' +
          '<td>'+r.left+'</td>';
        tbody.appendChild(tr);
      });
      document.getElementById('count').textContent = rows.length;
    }

    // render UI chrome
    (function initUI(){
      // Replace login with simple client-side "admin/admin" as before
      const ok = sessionStorage.getItem('admin_ok')==='1';
      const loginCard=document.getElementById('loginCard'), adminUI=document.getElementById('adminUI');
      function showLogin(){ loginCard.style.display='block'; adminUI.style.display='none'; }
      function showAdmin(){ loginCard.style.display='none'; adminUI.style.display='block'; renderAdmin(); }
      if(ok) showAdmin(); else showLogin();
      document.getElementById('loginBtn').onclick=()=>{
        const u=document.getElementById('u').value.trim();
        const p=document.getElementById('p').value.trim();
        if(u==='admin' && p==='admin'){ sessionStorage.setItem('admin_ok','1'); showAdmin(); } else alert('Nespr√°vne √∫daje');
      };

      // Wire buttons
      const reloadBtn = document.getElementById('reload');
      const exportBtn = document.getElementById('export');
      reloadBtn.onclick = renderAdmin;
      exportBtn.onclick = () => { window.location.href = CSV_URL; };
    })();
</script>
</body>
</html>
