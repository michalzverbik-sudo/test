<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BOL Timer ‚Äì ZXing‚ÄëWASM (CDN)</title>
  <meta name="theme-color" content="#00539f">
  <style>
    :root{--blue:#00539f;--red:#e41e26;--bg:#f7f9fb;--radius:14px}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    h1{color:var(--red);margin:0 0 10px} .muted{color:#64748b}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.05);margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-weight:800;display:block;margin-bottom:6px}
    input{padding:12px;border:2px solid var(--blue);border-radius:12px;width:100%}
    .btn{padding:12px 16px;border-radius:12px;border:2px solid var(--blue);background:var(--blue);color:#fff;font-weight:800;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--blue)}
    .btn.danger{background:#e41e26;border-color:#e41e26}
    video{width:100%;max-height:48vh;background:#000;border-radius:12px}
    canvas{display:none}
    .timer{font-size:36px;font-weight:900;color:var(--red)}
    .note{background:#fff3cd;border:1px solid #ffe08a;color:#7a5d00;border-radius:8px;padding:8px 10px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px 6px;border-bottom:1px solid #e5e7eb}
    th{border-bottom:2px solid var(--blue);text-align:left}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#dbeafe;color:#1e3a8a;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BOL Timer ‚Äì ZXing‚ÄëWASM (CDN)</h1>
    <p class="note">Kamera funguje len cez <b>HTTPS</b> alebo <b>localhost</b>. T√°to verzia pou≈æ√≠va <code>zxing-wasm@2.2.2</code> z CDN, tak≈æe <b>nedokop√≠ruje≈° ≈æiadne .wasm</b> s√∫bory.</p>

    <div class="card">
      <h3>√ödaje</h3>
      <div class="row">
        <div style="flex:2 1 280px">
          <label>BOL / EAN (3+ ƒç√≠slic)</label>
          <input id="code" placeholder="naskenuj alebo nap√≠≈°" inputmode="numeric" autocomplete="off" />
        </div>
        <div style="flex:1 1 160px">
          <label>&nbsp;</label>
          <button id="scan" class="btn ghost">üì∑ Skenova≈•</button>
        </div>
        <div style="flex:2 1 280px">
          <label>Meno</label>
          <input id="name" placeholder="napr. Jana K." autocomplete="name" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="start" class="btn">‚ñ∂ ≈†tart</button>
        <button id="pause" class="btn ghost" disabled>‚è∏ Pauza</button>
        <button id="resume" class="btn" disabled>‚èµ Pokraƒçova≈•</button>
        <button id="stop" class="btn danger" disabled>‚èπ Stop</button>
      </div>
      <div id="active" class="row" style="justify-content:space-between;margin-top:10px;display:none">
        <div><b id="meta">-</b></div>
        <div class="timer" id="timer">00:00:00</div>
      </div>
    </div>

    <div class="card">
      <h3>Tabuƒæka</h3>
      <table>
        <thead><tr><th>K√≥d</th><th>Meno</th><th>≈†tart</th><th>Koniec</th><th>ƒåist√Ω ƒças</th><th>Pauzy</th><th>Zostalo</th></tr></thead>
        <tbody id="tbl"></tbody>
      </table>
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button id="export" class="btn ghost">Export CSV</button>
        <button id="clear" class="btn ghost">Vymaza≈• v≈°etko</button>
      </div>
    </div>

    <div class="card">
      <span class="pill">Stav skenera</span>
      <div id="status" class="muted">Neakt√≠vny</div>
      <video id="video" playsinline muted></video>
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <!-- ZXing‚ÄëWASM (IIFE) ‚Äì reader only -->
  <script src="https://cdn.jsdelivr.net/npm/zxing-wasm@2.2.2/dist/iife/reader/index.js"></script>
  <script>
    const $=s=>document.querySelector(s);
    const status=$('#status'), video=$('#video'), canvas=$('#canvas');
    const fmt=n=>String(n).padStart(2,'0');
    const fmtHMS=ms=>{const s=Math.floor(ms/1000);const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return fmt(h)+':'+fmt(m)+':'+fmt(sec);};
    const KEY='bol_zxing_cdn_v1'; let DB=JSON.parse(localStorage.getItem(KEY)||'{"tasks":[]}'); const save=()=>localStorage.setItem(KEY, JSON.stringify(DB));

    // Timer state
    let active=null, interval=null;
    function setBtns(run){ $('#start').disabled=!!active; $('#pause').disabled=!active||!run; $('#resume').disabled=!active||run; $('#stop').disabled=!active; $('#active').style.display = active?'flex':'none'; }
    function tick(){ if(!active) return; const now=Date.now(); const paused = active.running ? active.pausedAccumMs : (active.pausedAccumMs + (now - (active.pauseStartMs||now))); $('#timer').textContent = fmtHMS(Math.max(0, now - active.startMs - paused)); }
    $('#start').onclick=()=>{ const code=$('#code').value.trim(), name=$('#name').value.trim(); if(!code||!name){ alert('Zadaj k√≥d a meno.'); return; } active={ id:Date.now().toString(36), code, name, startMs:Date.now(), pausedAccumMs:0, pauseStartMs:null, running:true, pauses:0 }; $('#meta').textContent=code+' ‚Ä¢ '+name; setBtns(true); if(interval) clearInterval(interval); interval=setInterval(tick,500); tick(); };
    $('#pause').onclick=()=>{ if(!active||!active.running) return; active.running=false; active.pauseStartMs=Date.now(); active.pauses++; setBtns(false); tick(); };
    $('#resume').onclick=()=>{ if(!active||active.running) return; active.running=true; if(active.pauseStartMs){ active.pausedAccumMs += Date.now()-active.pauseStartMs; active.pauseStartMs=null; } setBtns(true); tick(); };
    $('#stop').onclick=()=>{ if(!active) return; const leftover = prompt('Zostalo do skladu (kart√≥ny):','0'); const n = Math.max(0, parseInt(leftover||'0',10)||0); const now=Date.now(); const paused = active.running ? active.pausedAccumMs : (active.pausedAccumMs + (now - (active.pauseStartMs||now))); const clean = Math.max(0, now - active.startMs - paused); DB.tasks.push({id:active.id, code:active.code, name:active.name, startISO:new Date(active.startMs).toISOString(), endISO:new Date(now).toISOString(), cleanMs:clean, pauses:active.pauses, leftoverCartons:n}); save(); active=null; if(interval){clearInterval(interval); interval=null;} setBtns(false); $('#timer').textContent='00:00:00'; $('#code').value=''; render(); };

    function render(){ $('#tbl').innerHTML = DB.tasks.slice().reverse().map(r=>`<tr><td>${r.code}</td><td>${r.name}</td><td>${new Date(r.startISO).toLocaleString('sk-SK')}</td><td>${new Date(r.endISO).toLocaleString('sk-SK')}</td><td style="color:#e41e26;font-weight:800">${fmtHMS(r.cleanMs)}</td><td>${r.pauses}</td><td>${r.leftoverCartons||0}</td></tr>`).join(''); }
    render();
    $('#export').onclick=()=>{ if(DB.tasks.length===0) return alert('≈Ωiadne z√°znamy.'); const esc=s=>`"`+String(s).replace(/"/g,'""')+`"`; let csv=['BOL','Meno','≈†tart','Koniec','ƒåist√Ω ƒças','Pauzy','Zostalo'].join(',')+'\n'; DB.tasks.forEach(t=>{ csv += [t.code,esc(t.name),new Date(t.startISO).toLocaleString('sk-SK'),new Date(t.endISO).toLocaleString('sk-SK'),fmtHMS(t.cleanMs),t.pauses,t.leftoverCartons].join(',')+'\n'; }); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='BOL_timer.csv'; a.click(); };
    $('#clear').onclick=()=>{ if(!confirm('Naozaj vymaza≈• v≈°etky z√°znamy?')) return; DB={tasks:[]}; save(); render(); };

    // ZXing‚ÄëWASM: read from camera frames (IIFE global is ZXingWASM)
    const ZX = window.ZXingWASM;
    const FORMATS = ["EAN-13","EAN-8","UPC-A","UPC-E","Code128","ITF","Code39","DataMatrix","PDF417","QRCode"];

    async function ensureCam(){ if (video.srcObject) return; const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false }); video.srcObject = s; await video.play(); }
    async function stopCam(){ try{ video.srcObject?.getTracks().forEach(t=>t.stop()); }catch{} video.srcObject=null; }

    let scanning=false, raf=0;
    async function startScan(){ if(scanning) return; scanning=true; status.textContent='Inicializujem skener‚Ä¶'; await ensureCam();
      // warm‚Äëup one frame
      await new Promise(r=>setTimeout(r,200));
      status.textContent='Be≈æ√≠'; loop();
    }
    async function loop(){
      if(!scanning) return;
      const w = canvas.width = video.videoWidth || 640;
      const h = canvas.height = video.videoHeight || 360;
      const ctx = canvas.getContext('2d', { willReadFrequently:true });
      ctx.drawImage(video, 0, 0, w, h);
      const img = ctx.getImageData(0, 0, w, h);
      try {
        const res = await ZX.readBarcodes(img, { tryHarder:true, formats: FORMATS, maxNumberOfSymbols:1 });
        if (Array.isArray(res) && res[0] && res[0].text) {
          const code = res[0].text.trim();
          document.getElementById('code').value = code;
          // auto-stop
          await stopScan();
          scanning=false;
          status.textContent='N√°jden√©: '+code+' ('+(res[0].format||'')+')';
          return;
        }
      } catch (e) {
        // ignore per‚Äëframe errors
      }
      raf = requestAnimationFrame(loop);
    }
    async function stopScan(){ cancelAnimationFrame(raf); await stopCam(); status.textContent='Zastaven√©'; }

    // Buttons
    document.getElementById('scan').onclick = ()=>{
      if (!location.protocol.startsWith && !(location.protocol.startsWith('https') || location.hostname==='localhost')) {
        alert('Kamera vy≈æaduje HTTPS alebo localhost.');
        return;
      }
      startScan();
    };
    // Optional: stop camera when leaving page
    window.addEventListener('pagehide', stopScan);
  </script>
</body>
</html>
