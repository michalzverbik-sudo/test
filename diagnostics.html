<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Camera Diagnostics</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;padding:16px;background:#f7f9fb;color:#111}
    h1{margin:0 0 8px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:12px 0}
    button{padding:10px 14px;border-radius:10px;border:2px solid #2563eb;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
    button.ghost{background:#fff;color:#2563eb}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
    pre{background:#0b1021;color:#d6e2ff;padding:10px;border-radius:8px;overflow:auto}
    video{width:100%;max-height:50vh;background:#000;border-radius:8px}
    .ok{color:#16a34a;font-weight:800}
    .bad{color:#dc2626;font-weight:800}
  </style>
</head>
<body>
  <h1>Diagnostika kamery</h1>
  <div class="card">
    <div>Secure context (HTTPS/localhost): <span id="sec"></span></div>
    <div>Permissions API (camera): <span id="perm"></span></div>
    <div>Zoznam kamier:</div>
    <ul id="cams"></ul>
    <div>Chyby:</div>
    <pre id="log">‚Äî</pre>
  </div>

  <div class="card">
    <button id="ask" class="ghost">1) Vyp√Ωta≈• povolenie</button>
    <button id="open">2) Otvori≈• n√°hƒæad</button>
    <button id="stop" class="ghost">3) Zastavi≈• n√°hƒæad</button>
    <video id="video" playsinline muted></video>
  </div>

  <script>
    const $=s=>document.querySelector(s);
    const log=(...a)=>{ const el=$('#log'); el.textContent = (el.textContent==='‚Äî'?'':el.textContent+'\n') + a.join(' '); console.log(...a); };

    // Secure context
    $('#sec').textContent = window.isSecureContext ? '‚úÖ √Åno' : '‚ùå Nie (pou≈æi HTTPS alebo localhost)';
    // Permissions
    (async()=>{
      try{
        const st = await navigator.permissions.query({name:'camera'});
        $('#perm').textContent = 'üîé ' + st.state;
        st.onchange = ()=> $('#perm').textContent = 'üîé ' + st.state;
      }catch(e){
        $('#perm').textContent = 'nepodporovan√©';
      }
    })();

    async function listCams(){
      try{
        const devs = await navigator.mediaDevices.enumerateDevices();
        const vids = devs.filter(d=>d.kind==='videoinput');
        $('#cams').innerHTML = vids.map(v=>'<li>'+ (v.label||'(bez n√°zvu)') +' ‚Äî <code>'+v.deviceId+'</code></li>').join('') || '<li>‚Äî</li>';
      }catch(e){ log('enumerateDevices error:', e); }
    }
    listCams();

    let stream=null;
    $('#ask').onclick = async ()=>{
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' } });
        log('getUserMedia: OK. Stopy:', stream.getTracks().map(t=>t.label).join(', '));
        // stop immediately (preflight)
        stream.getTracks().forEach(t=>t.stop()); stream=null;
        await listCams();
      }catch(e){
        log('getUserMedia ERROR:', e.name, e.message);
        alert('Povolenie kamery zlyhalo: '+e.name+' '+e.message+'\nSkontroluj HTTPS a povolenia prehliadaƒça.');
      }
    };

    $('#open').onclick = async ()=>{
      try{
        if (stream) { stream.getTracks().forEach(t=>t.stop()); }
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' } });
        $('#video').srcObject = stream; $('#video').play();
      }catch(e){ log('open preview error:', e.name, e.message); alert('N√°hƒæad sa nepodarilo otvori≈•: '+e.message); }
    };
    $('#stop').onclick = ()=>{ try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(e){} };
  </script>
</body>
</html>
